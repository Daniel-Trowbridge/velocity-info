# UC Velocity `release-events-api` REST API
*16 October 2019*
_Version: 0.0.3_
### Routes:
`<velocityURL>/release-events-api/api<route>`
Example: https://ucv-stage.hclpnp.com/release-events-api/api/v1/deployments would query the deployments route of UrbanCode's Stage UCV instance

### Authorization:
**Required!** Access keys are generated from the UCV UI:
  - *Settings>My Profile>Create* or *New User Access Key* (depending on whether user has existing keys)
  - In the request header, include:
    - Key: `Authorization`
    - Value: `UserAccessKey <insert key generated by UCV>` 

<hr>

### /v1/deployments 

#### POST 

##### Description:
Create a deployment programatically

##### POST Payload Template
```json
{
    "version_name": "<your version name>",
    "version_id_external": "<external version ID>",
    "type": "<deployment type>",
    "id_external": "<optional external ID>",
    "tenant_id": "<your tenantId>",
    "application": {
        "name": "<Your Application Name>"
        },
    "environment_id": "<build environment ID>",
    "environment_name": "<build environment name>",
    "description": "<deployment description>",
    "by_user": "<deployment user>",
    "result": "<deployment result>",
    "start_time": <Epoch timestamp in milliseconds>,
    "end_time": <Epoch timestamp in milliseconds>
}
```

##### cURL Example
```bash
curl -k -X POST "https://demo.uc-velocity.com/api/v1/deployments" -H 'Authorization: UserAccessKey <YOUR ACCESS KEY>' -H 'Content-Type: application/json' -d '{
    "version_name": "1.0",
    "version_id_external": "1.0",
    "type": "Jenkins",
    "id_external": "1.0",
    "tenant_id": "5ade13625558f2c6688d15ce",
    "application": {
        "name": "Test Application 2"
        },
    "environment_id": "DEV",
    "environment_name": "DEV", 
    "description": "Deployment to DEV 2",
    "by_user": "admin",
    "result": "success",
    "start_time": 1571236638000,
    "end_time": 1571236638000
}'
```

##### Responses

| Code | Description |
| ---- | ----------- |
| 200 | Expected response to a valid request |

<!-- #### GET
TODO: says no required params, but receives a `200` with an error message of `Argument passed in must be a single String of 12 bytes or a string of 24 hex characters`. Receives different error message if using UserAccessKey rather than Bearer. If I use tenantId to query ucv-stage, I receive `Executor error during find command: OperationFailed: Sort operation used more than the maximum 33554432 bytes of RAM. Add an index, or specify a smaller limit.`  Seems to work if tenantId is provided in query but can't figure out how to properly use with any additional parameters

##### Description:

Query deployments

##### Parameters

| Name | Located in | Description | Required | Schema |
| ---- | ---------- | ----------- | -------- | ---- |
| tenantId | query |  | No | string |
| teamIds | query |  | No | [ string ] |
| tags | query |  | No | [ string ] |
| appIds | query |  | No | [ string ] |
| customStartDate | query |  | No | dateTime |
| customEndDate | query |  | No | dateTime |
| relativeTime | query |  | No | [RELATIVE_DATE_INTERVAL](#relative_date_interval) |
| queryString | query | DQL (DevOps Query Language) String | No | string |
| pagination | query |  | No | [PaginationOptions](#paginationoptions) |
| sort | query |  | No | [DeploySortOptions](#deploysortoptions) |
| type | query |  | No | [ string ] |
| result | query |  | No | [ string ] |
| name | query |  | No | [ string ] |
| environment_name | query |  | No | [ string ] |
| version_name | query |  | No | [ string ] |

##### Responses

| Code | Description |
| ---- | ----------- |
| 200 | Expected response to a valid request | -->

<hr>

### /v1/builds

#### POST

##### Description:

Create a build programatically

##### POST Payload Template
```json
{
    "id": "<your build ID>",
    "name": "<build name, often your version number>",
    "versionName": "<your version name>",
    "application": {
        "externalId": "<optional external ID>",
        "name": "<Your Application Name>"
        },
    "tenantId": "<your tenantId>",
    "status": "<build status>",
    "url": "<build URL>",
    "startTime": <Epoch timestamp in milliseconds>,
    "endTime": <Epoch timestamp in milliseconds>,
    "requestor": "admin",
    "revision": "<revision, often your commit ID>",
    "source": "<build source, such as Jenkins>",
    "steps": [],
    "history": []
}

```
##### cURL Example
```bash
curl -k -X POST "https://demo.uc-velocity.com/api/v1/builds" -H 'Authorization: UserAccessKey <YOUR ACCESS KEY>' -H 'Content-Type: application/json' -d '{
"id": "TEST_ID",
    "name": "1.0",
    "versionName": "1.0",
    "application": {
        "name": "Test Application"
        },
    "tenantId": "5ade13625558f2c6688d15ce",
    "status": "success",
    "url": "http://www.google.com",
    "startTime": 1571236638000,
    "endTime": 1571236638000,
    "requestor": "admin",
    "revision": "12345678",
    "source": "Jenkins",
    "steps": [],
    "history": []
}'
```

##### Responses

| Code | Description |
| ---- | ----------- |
| 200 | Expected response to a valid request |

<!-- #### GET
TODO: says no required params, but receives a `400 bad request` with an error message of  `Unknown argument \"data\" on field \"builds\" of type \"Query\".`. Unsure how to use it

##### Description:

Query build history using the query string

##### Parameters

| Name | Located in | Description | Required | Schema |
| ---- | ---------- | ----------- | -------- | ---- |
| category | query |  | No | string |
| filters | query |  | No | [BuildChartFilters](#buildchartfilters) |
| pagination | query |  | No | [PaginationOptions](#paginationoptions) |
| sort | query |  | No | [BuildSortOptions](#buildsortoptions) |

##### Responses

| Code | Description |
| ---- | ----------- |
| 200 | Expected response to a valid request | -->

<!-- <hr> -->

<!-- ### /v1/workflow

#### GET
##### Description:

Query a single workflow ("value stream map") by its `workflowId`. Returns the same JSON object as the "Download value stream map" option from the value stream UI page

##### Parameters

| Name | Located in | Description | Required | Schema |
| ---- | ---------- | ----------- | -------- | ---- |
| workflowId | query |  | Yes | string |

##### cURL Example
```bash
curl -X GET \
  '<your UCV URL>/release-events-api/api/v1/workflow?workflowId=<your workflow ID>' \
  -H 'Authorization: UserAccessKey <your key>' \
```

##### Responses

| Code | Description |
| ---- | ----------- |
| 200 | Expected response to a valid request | -->

<!-- <hr> -->

<!-- ### /v1/workflowIds
TODO: unclear to user on what difference is between `workflow` and `workflowIds` endpoint, but they have different responses. Needs better description, maybe change endpoint name since it seems like I am querying the same thing I am providing

#### GET
##### Description:

Query workflow internal Ids

##### Parameters

| Name | Located in | Description | Required | Schema |
| ---- | ---------- | ----------- | -------- | ---- |
| workflowId | query |  | Yes | string |

##### cURL Example
```bash
curl -X GET \
  '<your UCV URL>/release-events-api/api/v1/workflowIds?workflowId=<your workflow ID>' \
  -H 'Authorization: UserAccessKey <your key>' \
```

##### Responses

| Code | Description |
| ---- | ----------- |
| 200 | Expected response to a valid request |

<hr>

### /v1/dots
TODO: need more detail in description - receiving 200 with error message of `could not find build to use for gate check` which maybe makes sense but seems likely to be unclear to API user. Maybe we remove this as we aren't currently supporting gates?

#### GET
##### Description:

Check stage gates for build

##### Parameters

| Name | Located in | Description | Required | Schema |
| ---- | ---------- | ----------- | -------- | ---- |
| pipelineId | query |  | Yes | string |
| stageName | query |  | Yes | string |
| buildId | query |  | No | string |
| versionId | query |  | No | string |

##### Responses

| Code | Description |
| ---- | ----------- |
| 200 | Expected response to a valid request | -->

<hr> 

### /v1/metrics

<!-- #### GET
TODO: weird 200 response with `Internal server error ...` if sending blank query with Bearer auth or `Cannot read property 'tenantId' of undefined` if blank query with Access Key auth. Tried various queries but with no success

##### Description:

Query metrics using the DQL query string

##### Parameters

| Name | Located in | Description | Required | Schema |
| ---- | ---------- | ----------- | -------- | ---- |
| groupBy | query |  | No | string |
| summarizationInterval | query |  | No | [SUMMARIZATION_INTERVAL](#summarization_interval) |
| summarizationOperation | query |  | No | [SUMMARIZATION_OPERATION](#summarization_operation) |
| filters | query |  | No | [ChartFilters](#chartfilters) |
| pagination | query |  | No | [PaginationOptions](#paginationoptions) |
| metricDefinition | query |  | No | string |
| sort | query |  | No | [MetricsSortOptions](#metricssortoptions) |

##### Responses

| Code | Description |
| ---- | ----------- |
| 200 | Expected response to a valid request | -->

#### POST

##### Description:

Upload metrics

##### POST Payload Template
```json
{
    "tenantId": "<your tenantId>",
    "dataSet": "<your dataSet>",
    "record": {
        "metricDefinitionId": "<ID value for your existing Metric Definition>",
        "description": "<your metric description>",
        "metricsRecordUrl": "<URL for metrics record>",
        "recordName": "<your record name>",
        "pluginType": "<type of plugin>",
        "executionDate": <Epoch timestamp in milliseconds>,
        "dataFormat": "<data format>",
        "value": <integer value>
    },
    "application": {
        "name": "<your application's name>"
    }
}
```

##### cURL Example
```bash
curl -k -X POST "https://demo.uc-velocity.com/api/v1/metrics" -H 'Authorization: UserAccessKey <YOUR ACCESS KEY>' -H 'Content-Type: application/json' -d '{
    "tenantId": "5ade13625558f2c6688d15ce",
    "dataSet": "Test Suite",
    "record": {
        "metricDefinitionId": "CUSTOMER_SATISFACTION",
        "description": "Customer satisfaction metric",
        "metricsRecordUrl": "https://www.google.com",
        "recordName": "Customer Survey",
        "pluginType": "plugin",
        "executionDate": 1571236639000,
        "dataFormat": "custom",
        "value": 50
    },
    "application": {
        "name": "Test Application 2"
    }
}'
```

##### Responses

| Code | Description |
| ---- | ----------- |
| 200 | Expected response to a valid request |

<hr>

### /v1/metrics/upload

#### POST
##### Description:

Upload metrics file

##### cURL Example
```bash
curl --request POST --url https://demo.uc-velocity.com/release-events-api/api/v1/metrics/upload -H "Authorization: UserAccessKey <YOUR ACCESS KEY>" --form 'payload={
    "tenantId": "5ade13625558f2c6688d15ce",
    "record": {
        "metricsRecordUrl": "http://myjenkins/1.8425",
        "metricDefinitionId": "Unit Tests",
        "recordName": "Test version 8425",
        "pluginType": "junitXML",
        "executionDate": 1571240042000,
        "dataFormat": "junitXML"
    },
    "application": {
        "name": "JKE-Finance"
    },
    "build": {
        "url": "http://myjenkins/1.8425"
    }
}' -k  --form file=@junit.xml -i
```

##### Responses

| Code | Description |
| ---- | ----------- |
| 200 | Expected response to a valid request |

<hr>

### /v1/metricDefinition

<!-- #### GET
##### Description:

GET a single metric definition by its `id` or `name` (case-sensitive). Either `id` or `name` must be provided along with `tenantId`

##### Parameters

| Name | Located in | Description | Required | Schema |
| ---- | ---------- | ----------- | -------- | ---- |
| id | query |  | No | string |
| name | query |  | No | string |
| tenantId | query |  | Yes | string |
| checkEnabled | query |  If checkEnabled is true, then it will return metric definitions that are not enabled as well  | No | boolean |

##### cURL Example
```bash
curl -X GET \
  '<your UCV URL>/release-events-api/api/v1/metricDefinition?name=<your metric name>&tenantId=your tenantId' \
  -H 'Authorization: UserAccessKey <your key>' \
```

##### Responses

| Code | Description |
| ---- | ----------- |
| 200 | Expected response to a valid request | -->

#### POST

##### Description:

POST endpoint for MetricDefinition

##### POST Payload Template
```json
{
	"id": "<YOUR_METRICDEFINITION_ID>",
	"name": "<Your Metric Definition Name>",
	"category": "<your metric definition category>",
	"tenantId": "<your tenantId>",
	"chartDefaults": {
	  "groupBy": "<'value', 'status', or 'result'>",
	  "chartType": "<'line' or 'bar'>",
	  "barMode": "<'stack' or 'group'>"
	},
	"aggregation":{
	  "operation": "<'sum'>"
	}
}
```

##### cURL Example
```bash
curl -k -X POST "https://demo.uc-velocity.com/api/v1/metricDefinition" -H 'Authorization: UserAccessKey <YOUR ACCESS KEY>' -H 'Content-Type: application/json' -d '{
	"id": "CUSTOMER_SATISFACTION",
	"name": "Customer Satisfaction",
	"category": "quality",
	"tenantId": "5ade13625558f2c6688d15ce",
	"chartDefaults": {
	  "groupBy": "result",
	  "chartType": "bar",
	  "barMode": "stack"
	},
	"aggregation":{
	  "operation": "sum"
	}
}'
```

##### Responses

| Code | Description |
| ---- | ----------- |
| 200 | Expected response to a valid request |

<!-- #### PUT
##### Description:

PUT endpoint for MetricDefinition

##### Responses

| Code | Description |
| ---- | ----------- |
| 200 | Expected response to a valid request | -->

<!-- #### DELETE

##### Description:

DELETE a single metric definition by its `id` or `name` (case-sensitive). Either `id` or `name` must be provided along with `tenantId`

##### cURL Example
```bash
curl -X DELETE \
  '<your UCV URL>/release-events-api/api/v1/metricDefinition?id=<your id to delete>&tenantId=<your tenantId>' \
  -H 'Authorization: UserAccessKey <your key>' \
```

##### Responses

| Code | Description |
| ---- | ----------- |
| 200 | Expected response to a valid request | -->

<!-- <hr> -->

<!-- ### /v1/metricDefinitions

#### GET
##### Description:

Get all metric definitions

##### Parameters

| Name | Located in | Description | Required | Schema |
| ---- | ---------- | ----------- | -------- | ---- |
| tenantId | query |  | Yes | string |
| checkEnabled | query |  If checkEnabled is true, then it will return metric definitions that are not enabled as well  | No | boolean |
| ids | query |  | No | [ string ] |

##### cURL Example
```bash
curl -X GET \
  '<your UCV URL>/release-events-api/api/v1/metricDefinitions?tenantId=<your tenantId>' \
  -H 'Authorization: UserAccessKey <your key>' \
```

##### Responses

| Code | Description |
| ---- | ----------- |
| 200 | Expected response to a valid request | -->

<!-- <hr> -->

<!-- ### /v1/issues

#### POST
##### Description:

Create or update a set of issues

##### Responses

| Code | Description |
| ---- | ----------- |
| 200 | Expected response to a valid request | -->
